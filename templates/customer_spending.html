{% extends "base.html" %}

{% block content %}
<h2>My Spending</h2>

<hr>

<h3>Default View (Last 12 Months)</h3>
<p><strong>Total spending in last 12 months:</strong> {{ total_12 }}</p>

<div class="chart-card">
    <canvas id="last6Chart" width="400" height="200"></canvas>
</div>


<hr>

<h3>Custom Date Range</h3>

<!-- 这里把表单包装成一个 filter-bar 风格 -->
<form method="get" action="{{ url_for('customer.spending') }}" class="chart-filter-bar">
    <div class="filter-item">
        <label>From:</label>
        <input type="date" name="date_from" value="{{ date_from }}">
    </div>
    <div class="filter-item">
        <label>To:</label>
        <input type="date" name="date_to" value="{{ date_to }}">
    </div>
    <button type="submit" class="filter-btn">Show Spending</button>
</form>

{% if date_from and date_to %}
    <h4>Custom Range: {{ date_from }} to {{ date_to }}</h4>
    <p><strong>Total spending in this range:</strong> {{ custom_total }}</p>
    <div class="chart-card">
        <canvas id="customChart" width="400" height="200"></canvas>
    </div>
{% endif %}



<!-- Include Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Default view - last 6 months
    const last6Labels = {{ last6_labels | tojson | safe }};
    const last6Values = {{ last6_values | tojson | safe }}.map(Number);

    if (last6Labels.length && last6Values.length) {
        const ctx1 = document.getElementById('last6Chart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: last6Labels,
                datasets: [{
                    label: 'Spending (last 6 months)',
                    data: last6Values,
                    backgroundColor: 'rgba(54, 162, 235, 0.4)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    {% if date_from and date_to %}
    // Custom range chart
    const customLabels = {{ custom_labels | tojson | safe }};
    const customValues = {{ custom_values | tojson | safe }}.map(Number);

    if (customLabels.length && customValues.length) {
        const ctx2 = document.getElementById('customChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: customLabels,
                datasets: [{
                    label: 'Spending (custom range)',
                    data: customValues,
                    backgroundColor: 'rgba(255, 159, 64, 0.4)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    {% endif %}
</script>

{% endblock %}
