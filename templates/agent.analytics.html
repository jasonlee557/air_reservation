{% extends "base.html" %}

{% block content %}
<h2>Booking Agent Analytics</h2>

<hr>

<h3>Summary (Last 30 Days)</h3>
<ul>
  <li><strong>Total commission:</strong> {{ stats_30.total_commission or 0 }}</li>
  <li><strong>Tickets sold:</strong> {{ stats_30.tickets_sold or 0 }}</li>
  <li><strong>Average commission per ticket:</strong> {{ stats_30.avg_commission or 0 }}</li>
</ul>

<hr>

<h3>Top 5 Customers by Number of Tickets (Last 6 Months)</h3>
{% if top_customers_6_months and top_customers_6_months|length > 0 %}
  <canvas id="ticketsChart" style="max-width: 700px;"></canvas>
{% else %}
  <p>No data for the last 6 months.</p>
{% endif %}

<h3>Top 5 Customers by Commission (Last Year)</h3>
{% if top_customers_1_year and top_customers_1_year|length > 0 %}
  <canvas id="commissionChart" style="max-width: 700px;"></canvas>
{% else %}
  <p>No data for the last year.</p>
{% endif %}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Serialize data to valid JSON for Chart.js
const ticketsLabels = {{ (top_customers_6_months or []) | map(attribute='customer_email') | list | tojson }};
const ticketsData   = {{ (top_customers_6_months or []) | map(attribute='tickets_count') | list | tojson }};

const commLabels = {{ (top_customers_1_year or []) | map(attribute='customer_email') | list | tojson }};
const commData   = {{ (top_customers_1_year or []) | map(attribute='total_commission') | list | tojson }};

{% if top_customers_6_months and top_customers_6_months|length > 0 %}
new Chart(document.getElementById('ticketsChart'), {
    type: 'bar',
    data: {
        labels: ticketsLabels,
        datasets: [{
            label: 'Tickets sold',
            data: ticketsData
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { precision: 0 }
            }
        }
    }
});
{% endif %}

{% if top_customers_1_year and top_customers_1_year|length > 0 %}
new Chart(document.getElementById('commissionChart'), {
    type: 'bar',
    data: {
        labels: commLabels,
        datasets: [{
            label: 'Total commission (10% of price)',
            data: commData
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
{% endif %}
</script>

{% endblock %}
